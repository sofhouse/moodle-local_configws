define("local_configws/autoconfig",["exports","core_form/modalform","core/config","core/str"],(function(_exports,_modalform,_config,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modalform=_interopRequireDefault(_modalform),_config=_interopRequireDefault(_config);async function renderModal(formClass){let user=arguments.length>1&&void 0!==arguments[1]&&arguments[1],webservice=arguments.length>2&&void 0!==arguments[2]&&arguments[2],target=arguments.length>3&&void 0!==arguments[3]&&arguments[3],jsondata=arguments.length>4&&void 0!==arguments[4]&&arguments[4],args={};!1!==jsondata?(args=jsondata,args.userid=user,args.webservice=webservice,void 0!==args.functions&&(args.functions=args.functions.join(",")),args.isjson=1):args={user:user,webservice:webservice};const form=new _modalform.default({formClass:formClass,args:args,modalConfig:{title:(0,_str.get_string)("autoconfig","local_configws")},saveButtonText:"Save",returnFocus:target});form.addEventListener(form.events.FORM_SUBMITTED,(e=>{const response=e.detail;let redirect="".concat(_config.default.wwwroot,"/local/configws/autoconfig.php?"),first=!1;for(let key in response)first?first=!1:redirect+="&",redirect+="".concat(key,"=").concat(response[key]);window.location.assign(redirect)})),await form.show();let bodymodal=form.modal.getRoot().find(".modal-body")[0];const observer=new MutationObserver(((mutationsList,observer)=>{if(mutationsList.some((mutation=>mutation.addedNodes&&Array.from(mutation.addedNodes).some((()=>document.querySelector('.modal-body select[name="user"]')))))){observer.disconnect();const select=document.querySelector('.modal-body select[name="user"]'),webservice=document.querySelector('.modal-body select[name="webservice"]');select.addEventListener("change",(e=>{form.modal.destroy(),""!==e.target.value&&renderModal(formClass,e.target.value,webservice.value)}))}}));observer.observe(bodymodal,{childList:!0,subtree:!0});const wsobserver=new MutationObserver(((mutationsList,observer)=>{if(mutationsList.some((mutation=>mutation.addedNodes&&Array.from(mutation.addedNodes).some((()=>document.querySelector('.modal-body select[name="webservice"]')))))){if(observer.disconnect(),!1!==webservice&&"new"!==webservice){let savejsonbutton=document.querySelector('.modal-body button[name="jsonsave"]'),viewinexternal=document.querySelector('.modal-body button[name="viewinexternal"]');savejsonbutton.addEventListener("click",(()=>{let downloadlink="/pluginfile.php/10/local_configws/download/"+webservice+"/?userid="+user;window.location.assign(downloadlink)})),viewinexternal.addEventListener("click",(()=>{window.open("/admin/settings.php?section=externalservices","_blank")}))}document.querySelector('.modal-body button[name="jsonload"]').addEventListener("click",(()=>{const input=document.createElement("input");input.type="file",input.accept="application/json",input.addEventListener("change",(event=>{const file=event.target.files[0];if(file){const reader=new FileReader;reader.onload=async e=>{const jsonContent=e.target.result,data=JSON.parse(jsonContent);validateJson(data)?(form.modal.destroy(),await renderModal(formClass,data.userid,"new",target,data)):alert("Invalid JSON file")},reader.readAsText(file)}})),input.click()}));const select=document.querySelector('.modal-body select[name="webservice"]'),userid=document.querySelector('.modal-body select[name="user"]').value;select.addEventListener("change",(e=>{"new"!==e.target.value&&"0"!==e.target.value&&(form.modal.destroy(),renderModal(formClass,userid,e.target.value,target))}))}}));wsobserver.observe(bodymodal,{childList:!0,subtree:!0})}function validateJson(data){return"object"==typeof data&&(null!==data&&(void 0!==data.userid&&void 0!==data.name))}_exports.init=formClass=>{document.querySelector('[data-action="autoconfig-form"]').addEventListener("click",(async e=>{e.preventDefault();let target=e.currentTarget;renderModal(formClass,!1,!1,target)}))}}));

//# sourceMappingURL=autoconfig.min.js.map